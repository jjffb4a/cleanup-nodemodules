#!/bin/zsh
# clean-node_modules-log.sh   2025-05-11   loverk

ROOT="${1:-$HOME/projects}"
LOG="./pnpm-reinstall.json"
> "$LOG"

echo "📂 Scanning in: $ROOT"
echo "[" >> "$LOG"

FOLDERS=()
find "$ROOT" -type d -name "node_modules" -prune | while read -r NODE_MODULES; do
  PROJECT_DIR=$(dirname "$NODE_MODULES")

  if [[ -f "$PROJECT_DIR/pnpm-lock.yaml" || -f "$PROJECT_DIR/package.json" ]]; then
    echo "♻️  Deleting: $PROJECT_DIR/node_modules"
    rm -rf "$NODE_MODULES"
    FOLDERS+=("\"$PROJECT_DIR\"")
  else
    echo "⚠️  Skipped: $PROJECT_DIR (no lock file)"
  fi
done

echo "${(j:,\n:)FOLDERS}" >> "$LOG"
echo "]" >> "$LOG"
echo "✅ Log saved to $LOG"