#!/bin/zsh
# clean-node_modules-log.sh   2025-05-11   loverk


ROOT="$HOME/projects"
DEPTH=6
UNLIMITED=false
VERBOSE=false
LOG="./pnpm-reinstall.json"
SCANLOG="./scan.log"

usage() {
  echo "Usage: $0 [-d N] [--no-depth] [-v] [folder]"
  echo "  -d N         Max depth to scan (default: 6)"
  echo "  --no-depth   Unlimited depth (overrides -d)"
  echo "  -v           Verbose logging to scan.log"
  echo "  [folder]     Optional root path (default: ~/projects)"
  exit 1
}

# Spinner for feedback
spin() {
  local sp='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
  local i=0
  while kill -0 $1 2>/dev/null; do
    printf "\r⏳ Working... %s" "${sp:i++%${#sp}:1}"
    sleep 0.1
  done
  printf "\r✅ Done.%-20s\n"
}

# Parse args (short + long)
while [[ $# -gt 0 ]]; do
  case "$1" in
    -d)
      DEPTH="$2"
      shift 2
      ;;
    --no-depth)
      UNLIMITED=true
      shift
      ;;
    -v)
      VERBOSE=true
      shift
      ;;
    -*)
      usage
      ;;
    *)
      ROOT="$1"
      shift
      ;;
  esac
done

echo "📂 Scanning: $ROOT"
echo "🔍 Depth: ${UNLIMITED:+∞}${UNLIMITED:-$DEPTH}"
echo "📝 Output: $LOG"
> "$LOG"
> "$SCANLOG"
echo "[" >> "$LOG"
FIRST=true

# Build find command
if $UNLIMITED; then
  FIND_CMD=(find "$ROOT" -type d -name "node_modules" -prune)
else
  FIND_CMD=(find "$ROOT" -maxdepth "$DEPTH" -type d -name "node_modules" -prune)
fi

# Scan in background
(
  for NODE_MODULES in "${(@f)$(eval "${FIND_CMD[@]}")}"; do
    PROJECT_DIR="$(dirname "$NODE_MODULES")"
    echo "$PROJECT_DIR" >> "$SCANLOG"

    if [[ -f "$PROJECT_DIR/package.json" || -f "$PROJECT_DIR/pnpm-lock.yaml" ]]; then
      echo "♻️  Deleting: $PROJECT_DIR/node_modules"
      rm -rf "$NODE_MODULES"
      if $FIRST; then
        echo "  \"$PROJECT_DIR\"" >> "$LOG"
        FIRST=false
      else
        echo "  ,\"$PROJECT_DIR\"" >> "$LOG"
      fi
    else
      $VERBOSE && echo "⚠️  Skipped (no package.json): $PROJECT_DIR"
    fi
  done
  echo "]" >> "$LOG"
) &

SPIN_PID=$!
spin $SPIN_PID
wait $SPIN_PID