#!/bin/zsh
# clean-node_modules-log.sh   2025-05-11   loverk

#!/bin/zsh

ROOT="$HOME/projects"
DEPTH=6
LOG="./pnpm-reinstall.json"

while getopts "d:" opt; do
  case $opt in
    d) DEPTH=$OPTARG ;;
    *) echo "Usage: $0 [-d depth] [root_folder]"; exit 1 ;;
  esac
done
shift $((OPTIND - 1))
[[ -n "$1" ]] && ROOT="$1"

echo "ðŸ“‚ Scanning: $ROOT (max depth $DEPTH)"
echo "ðŸ“ Logging to: $LOG"

echo '[' > "$LOG"
FIRST=true

find "$ROOT" -maxdepth "$DEPTH" -type d -name "node_modules" -prune | while read -r NODE_MODULES; do
  PROJECT_DIR="$(dirname "$NODE_MODULES")"

  if [[ -f "$PROJECT_DIR/package.json" || -f "$PROJECT_DIR/pnpm-lock.yaml" ]]; then
    echo "â™»ï¸  Deleting: $PROJECT_DIR/node_modules"
    rm -rf "$NODE_MODULES"

    # Append JSON entry safely
    if $FIRST; then
      echo "  \"${PROJECT_DIR}\"" >> "$LOG"
      FIRST=false
    else
      echo "  ,\"${PROJECT_DIR}\"" >> "$LOG"
    fi
  else
    echo "âš ï¸  Skipped: $PROJECT_DIR (no package.json or lock file)"
  fi
done

echo "]" >> "$LOG"
echo "âœ… Done. You can now edit $LOG and run the reinstall script."