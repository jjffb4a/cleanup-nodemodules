#!/bin/zsh
# clean-node_modules-log.sh   2025-05-11   loverk


# Defaults
ROOT="$HOME/projects"
DEPTH=6
VERBOSE=false
LOG="./pnpm-reinstall.json"
SCANLOG="./scan.log"

# Usage help
usage() {
  echo "Usage: $0 [-d depth] [-v] [optional_root_folder]"
  echo "  -d N   Max depth to scan (default: 6)"
  echo "  -v     Verbose logging to scan.log"
  echo "  [folder] Optional root path (default: ~/projects)"
  exit 1
}

# Parse options
while getopts ":d:v" opt; do
  case $opt in
    d) DEPTH="$OPTARG" ;;
    v) VERBOSE=true ;;
    *) usage ;;
  esac
done
shift $((OPTIND - 1))

# Positional root path (after flags only)
if [[ $# -gt 1 ]]; then
  echo "âŒ Too many arguments."
  usage
fi

[[ -n "$1" ]] && ROOT="$1"

echo "ðŸ“‚ Scanning in: $ROOT (max depth $DEPTH)"
echo "ðŸ“ Logging JSON to: $LOG"
echo "ðŸ§¾ Verbose log (if enabled): $SCANLOG"

> "$LOG"
> "$SCANLOG"

echo "[" >> "$LOG"
FIRST=true
FOUND=false

find "$ROOT" -maxdepth "$DEPTH" -type d -name "node_modules" -prune | while read -r NODE_MODULES; do
  FOUND=true
  PROJECT_DIR="$(dirname "$NODE_MODULES")"
  echo "$PROJECT_DIR" >> "$SCANLOG"

  if [[ -f "$PROJECT_DIR/package.json" || -f "$PROJECT_DIR/pnpm-lock.yaml" ]]; then
    echo "â™»ï¸  Deleting: $PROJECT_DIR/node_modules"
    rm -rf "$NODE_MODULES"

    if $FIRST; then
      echo "  \"$PROJECT_DIR\"" >> "$LOG"
      FIRST=false
    else
      echo "  ,\"$PROJECT_DIR\"" >> "$LOG"
    fi
  else
    if $VERBOSE; then
      echo "âš ï¸  Skipped (no package.json): $PROJECT_DIR"
    fi
  fi
done

echo "]" >> "$LOG"

if ! $FOUND; then
  echo "âš ï¸  No node_modules folders found under: $ROOT" >> "$SCANLOG"
fi

echo "âœ… Done. Check:"
echo "   â†’ JSON: $LOG"
echo "   â†’ Verbose log: $SCANLOG"